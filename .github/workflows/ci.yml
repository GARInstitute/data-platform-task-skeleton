name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform fmt (check)
        run: terraform -chdir=infra fmt -recursive -check

      - name: Terraform init (no backend)
        run: terraform -chdir=infra init -backend=false

      - name: Terraform validate
        run: terraform -chdir=infra validate

      - name: Install conftest
        run: |
          CONFTEST_VERSION="0.60.0"
          curl -L -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/conftest
          conftest --version

      - name: Policy tests (OPA/Rego via conftest)
        run: |
          test -f evidence/plan.json || (echo "Missing evidence/plan.json. Generate via terraform plan + terraform show -json." && exit 1)
          conftest test evidence/plan.json -p policy
